<form #tasksForm="ngForm">
  <input
    type="text"
    name="tsk_name"
    placeholder="Write a task..."
    class="task"
    autocomplete="off"
    autofocus="true"
    *ngIf="!showBatchAdd"
    (keyup)="inputKeyUpHandler($event, { showBatchAdd: false })"
    [(ngModel)]="tsk_name"
  />
  <div class="grow-wrap" *ngIf="showBatchAdd">
    <textarea
      name="tsk_multiple_name"
      placeholder="Write a task per line..."
      class="task-multiple"
      (keyup)="inputKeyUpHandler($event, { showBatchAdd: false })"
      [(ngModel)]="tsk_multiple_name"
      spellcheck="false"
    ></textarea>
  </div>
  <button
    type="submit"
    (click)="addTask(tasksForm)"
    id="btnAddTask"
    *ngIf="(tasksForm.value.tsk_name && !showBatchAdd) || (tasksForm.value.tsk_multiple_name && showBatchAdd)"
  >
    Add task
  </button>
  <button (click)="toggleViewPostponed()" *ngIf="state.postponedTasksCount">
    {{ viewPostponed ? "hide" : "show" }} postponed
  </button>
  <button (click)="inputKeyUpHandler($event, { showBatchAdd: true })">
    {{ showBatchAdd ? "hide" : "show" }} batch add
  </button>
  <button (click)="toggleViewOptions()">
    {{ viewOptions ? "hide" : "show" }} options
  </button>
  <button
    (click)="options.optLimitTasksPerRecord = !options.optLimitTasksPerRecord"
    *ngIf="options.optShowLimitedTasksPerRecord"
  >
    {{ options.optLimitTasksPerRecord ? "remove" : "apply" }} limit view
  </button>
  <div *ngIf="viewETABeforeAdd">
    <strong>[{{ state.beforeAddTotalTasksWritten }} Tasks to Add]</strong>
    <strong>[TOTAL ETA: {{ formatTime(state.beforeAddTotalETA * 60) }}]</strong>
    <span *ngFor="let r of state.beforeAddETA">
      [{{ r.record }}: {{ formatTime(r.totalETA * 60) }} /
      {{r.totalETAPercentage}}%]
    </span>
  </div>
</form>
<div *ngIf="viewOptions">
  <hr />
  <button (click)="deleteTasks()" class="btn-secondary">
    delete all tasks
  </button>
  <button (click)="clearNextTasks()">clear next tasks listing</button>
  <br />
  <div class="task-options-section-title">Showing / hiding sections</div>
  <checkbox-option
    label="Show backlog section"
    optionId="optShowBacklog"
    [checked]="options.optShowBacklog"
    (onClick)="toggleOptionById($event)"
  ></checkbox-option>
  <checkbox-option
    label="Show Finished Today"
    optionId="optShowFinishedToday"
    [checked]="options.optShowFinishedToday"
    (onClick)="toggleOptionById($event)"
  ></checkbox-option>
  <checkbox-option
    label="Show Finished Yesterday"
    optionId="optShowFinishedYesterday"
    [checked]="options.optShowFinishedYesterday"
    (onClick)="toggleOptionById($event)"
  ></checkbox-option>
  <checkbox-option
    label="Show closed tasks section"
    optionId="optShowClosedTasks"
    [checked]="options.optShowClosedTasks"
    (onClick)="toggleOptionById($event)"
  ></checkbox-option>
  <checkbox-option
    label="Show week distribution report section"
    optionId="optShowReportsWeekDistribution"
    [checked]="options.optShowReportsWeekDistribution"
    (onClick)="toggleOptionById($event)"
  ></checkbox-option>
  <checkbox-option
    label="Show day distribution report section"
    optionId="optShowReportsDayDistribution"
    [checked]="options.optShowReportsDayDistribution"
    (onClick)="toggleOptionById($event)"
  ></checkbox-option>
  <checkbox-option
    label="Show qualifiers totals section"
    optionId="optShowQualifiersTotals"
    [checked]="options.optShowQualifiersTotals"
    (onClick)="toggleOptionById($event)"
  ></checkbox-option>

  <div class="task-options-section-title">Customize features</div>
  <checkbox-option
    label="Display days elapsed since task was added"
    optionId="optViewElapsedDays"
    [checked]="options.optViewElapsedDays"
    (onClick)="toggleOptionById($event)"
  ></checkbox-option>
  <checkbox-option
    label="Show Collapse/Expand buttons for record listings"
    optionId="optShowCollapseRecords"
    [checked]="options.optShowCollapseRecords"
    (onClick)="toggleOptionById($event)"
  ></checkbox-option>
  <checkbox-option
    label="Show tasks filter"
    optionId="optShowFilter"
    [checked]="options.optShowFilter"
    (onClick)="toggleOptionById($event)"
  ></checkbox-option>
  <checkbox-option
    label="Show sync tasks button"
    optionId="optShowSyncButton"
    [checked]="options.optShowSyncButton"
    (onClick)="toggleOptionById($event)"
  ></checkbox-option>
  <checkbox-option
    label="Use presentation mode for meetings"
    optionId="optUsePresentationMode"
    [checked]="options.optUsePresentationMode"
    (onClick)="toggleOptionById($event)"
  ></checkbox-option>
  <checkbox-option
    label="When a new task is added, add it to BACKLOG instead (of adding it to OPEN)"
    optionId="optNewTaskStatusIsBacklog"
    [checked]="options.optNewTaskStatusIsBacklog"
    (onClick)="toggleOptionById($event)"
  ></checkbox-option>
  <checkbox-option
    label="Show first 3 tasks per record"
    optionId="optShowLimitedTasksPerRecord"
    [checked]="options.optShowLimitedTasksPerRecord"
    (onClick)="toggleOptionById($event); updateState()"
  ></checkbox-option>
  <checkbox-option
    label="Colorize record listing without finished tasks today"
    optionId="optColorizeRecordWithoutDoneTasks"
    [checked]="options.optColorizeRecordWithoutDoneTasks"
    (onClick)="toggleOptionById($event)"
  ></checkbox-option>
  <checkbox-option
    label="Use end datetime of task timetracking as task done date when this one is a future datetime"
    optionId="optUseEndTTDateAsDoneDate"
    [checked]="options.optUseEndTTDateAsDoneDate"
    (onClick)="toggleOptionById($event)"
  ></checkbox-option>
  <checkbox-option
    label="Allow to edit ETA in tasks"
    optionId="optAllowToEditETA"
    [checked]="options.optAllowToEditETA"
    (onClick)="toggleOptionById($event)"
  ></checkbox-option>
  <checkbox-option
    label="Show task toolbar in desktop"
    optionId="optShowTaskToolbar"
    [checked]="options.optShowTaskToolbar"
    (onClick)="toggleOptionById($event)"
  ></checkbox-option>
  <checkbox-option
    label="Add newly created tasks to Next Tasks listing"
    optionId="optAddNewTasksToNextTasks"
    [checked]="options.optAddNewTasksToNextTasks"
    (onClick)="toggleOptionById($event)"
  ></checkbox-option>
  <checkbox-option
    label="Move time tracking to an available slot when task is marked done"
    optionId="optMoveTimetrackingToAvailableSlotWhenDone"
    [checked]="options.optMoveTimetrackingToAvailableSlotWhenDone"
    (onClick)="toggleOptionById($event)"
  ></checkbox-option>
  <checkbox-option
    label="Hide scrollbars for all Record listings when it has too much items"
    optionId="optHideScrollbarsInRecord"
    [checked]="options.optHideScrollbarsInRecord"
    (onClick)="toggleOptionById($event)"
  ></checkbox-option>
  <checkbox-option
    label="Use columns and full width for records (useful when record has too much items)"
    optionId="optUseColumnsForRecords"
    [checked]="options.optUseColumnsForRecords"
    (onClick)="toggleOptionById($event)"
  ></checkbox-option>
  <div>
    <input
      type="number"
      step="1"
      name="optRecordWidth"
      [(value)]="options.optRecordWidth"
      (change)="saveOption('optRecordWidth', $event.target.valueAsNumber)"
      class="field-input-small"
    />
    <label>Record listing width (in px, desktop only, minimum is 200)</label>
  </div>
  <div>
    <input
      type="number"
      step="1"
      name="optRecordHeight"
      [(value)]="options.optRecordHeight"
      (change)="saveOption('optRecordHeight', $event.target.valueAsNumber)"
      class="field-input-small"
    />
    <label>Record listing height (in px, desktop only)</label>
  </div>

  <div class="task-options-section-title">Showing / hiding Indicators</div>
  <checkbox-option
    label="Show Indicators Table"
    optionId="optShowIndicatorsTable"
    [checked]="options.optShowIndicatorsTable"
    (onClick)="toggleOptionById($event)"
  ></checkbox-option>
  <div *ngIf="options.optShowIndicatorsTable">
    <checkbox-option
      label="Show Indicator - Open Count"
      optionId="optShowIndicatorOpenCountEOD"
      [checked]="options.optShowIndicatorOpenCountEOD"
      (onClick)="toggleOptionById($event); calculateIndicators()"
    ></checkbox-option>
    <checkbox-option
      label="Show Indicator - Added ETA"
      optionId="optShowIndicatorAddedETA"
      [checked]="options.optShowIndicatorAddedETA"
      (onClick)="toggleOptionById($event); calculateIndicators()"
    ></checkbox-option>
    <checkbox-option
      label="Show Indicator - Added Count"
      optionId="optShowIndicatorAddedCount"
      [checked]="options.optShowIndicatorAddedCount"
      (onClick)="toggleOptionById($event); calculateIndicators()"
    ></checkbox-option>
    <checkbox-option
      label="Show Indicator - Closed ETA"
      optionId="optShowIndicatorClosedETA"
      [checked]="options.optShowIndicatorClosedETA"
      (onClick)="toggleOptionById($event); calculateIndicators()"
    ></checkbox-option>
    <checkbox-option
      label="Show Indicator - Closed Spent"
      optionId="optShowIndicatorClosedSpent"
      [checked]="options.optShowIndicatorClosedSpent"
      (onClick)="toggleOptionById($event); calculateIndicators()"
    ></checkbox-option>
    <checkbox-option
      label="Show Indicator - Closed Count"
      optionId="optShowIndicatorClosedCount"
      [checked]="options.optShowIndicatorClosedCount"
      (onClick)="toggleOptionById($event); calculateIndicators()"
    ></checkbox-option>
    <checkbox-option
      label="Show Indicator - Productivity Ratio"
      optionId="optShowIndicatorProductivityRatio"
      [checked]="options.optShowIndicatorProductivityRatio"
      (onClick)="toggleOptionById($event); calculateIndicators()"
    ></checkbox-option>
    <checkbox-option
      label="Show Indicator - Time Management Ratio"
      optionId="optShowIndicatorTimeManagementRatio"
      [checked]="options.optShowIndicatorTimeManagementRatio"
      (onClick)="toggleOptionById($event); calculateIndicators()"
    ></checkbox-option>
    <checkbox-option
      label="Show Indicator - First TimeTracking Stamp of Day"
      optionId="optShowIndicatorFirstTTStamp"
      [checked]="options.optShowIndicatorFirstTTStamp"
      (onClick)="toggleOptionById($event); calculateIndicators()"
    ></checkbox-option>
    <checkbox-option
      label="Show Indicator - Last TimeTracking Stamp of Day"
      optionId="optShowIndicatorLastTTStamp"
      [checked]="options.optShowIndicatorLastTTStamp"
      (onClick)="toggleOptionById($event); calculateIndicators()"
    ></checkbox-option>
    <checkbox-option
      label="Show Indicator - Open ETA"
      optionId="optShowIndicatorOpenETA"
      [checked]="options.optShowIndicatorOpenETA"
      (onClick)="toggleOptionById($event); calculateIndicators()"
    ></checkbox-option>
    <checkbox-option
      label="Show Indicator - Open Spent"
      optionId="optShowIndicatorOpenSpent"
      [checked]="options.optShowIndicatorOpenSpent"
      (onClick)="toggleOptionById($event); calculateIndicators()"
    ></checkbox-option>
    <checkbox-option
      label="Show Indicator - Backlog Count"
      optionId="optShowIndicatorBacklogCount"
      [checked]="options.optShowIndicatorBacklogCount"
      (onClick)="toggleOptionById($event); calculateIndicators()"
    ></checkbox-option>
    <checkbox-option
      label="Show Indicator - Backlog ETA"
      optionId="optShowIndicatorBacklogETA"
      [checked]="options.optShowIndicatorBacklogETA"
      (onClick)="toggleOptionById($event); calculateIndicators()"
    ></checkbox-option>
    <checkbox-option
      label="Show Indicator - All Open Count"
      optionId="optShowIndicatorAllOpenCount"
      [checked]="options.optShowIndicatorAllOpenCount"
      (onClick)="toggleOptionById($event); calculateIndicators()"
    ></checkbox-option>
    <checkbox-option
      label="Show Indicator - All Open ETA"
      optionId="optShowIndicatorAllOpenETA"
      [checked]="options.optShowIndicatorAllOpenETA"
      (onClick)="toggleOptionById($event); calculateIndicators()"
    ></checkbox-option>
  </div>

  <div>
    <div class="task-options-section-title">Keyboard Shortcuts Reference</div>
    <table>
      <thead>
        <tr>
          <th>Keys</th>
          <th>Where</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><kbd>F2</kbd></td>
          <td>In task</td>
          <td>Start/Stop task time tracking</td>
        </tr>
        <tr>
          <td><kbd>Alt</kbd> + <kbd>1</kbd></td>
          <td>In task</td>
          <td>Marks task as completed</td>
        </tr>
        <tr>
          <td><kbd>Alt</kbd> + <kbd>2</kbd></td>
          <td>In task</td>
          <td>Toggle qualifier: star</td>
        </tr>
        <tr>
          <td><kbd>Alt</kbd> + <kbd>3</kbd></td>
          <td>In task</td>
          <td>Toggle qualifier: highlighted</td>
        </tr>
        <tr>
          <td><kbd>Alt</kbd> + <kbd>4</kbd></td>
          <td>In task</td>
          <td>Toggle qualifier: priority</td>
        </tr>
        <tr>
          <td><kbd>Alt</kbd> + <kbd>5</kbd></td>
          <td>In task</td>
          <td>Toggle qualifier: important</td>
        </tr>
        <tr>
          <td><kbd>Alt</kbd> + <kbd>6</kbd></td>
          <td>In task</td>
          <td>Toggle qualifier: urgent</td>
        </tr>
        <tr>
          <td><kbd>Alt</kbd> + <kbd>7</kbd></td>
          <td>In task</td>
          <td>Toggle qualifier: unexpected</td>
        </tr>
        <tr>
          <td><kbd>Alt</kbd> + <kbd>8</kbd></td>
          <td>In task</td>
          <td>Toggle qualifier: progressed</td>
        </tr>
        <tr>
          <td><kbd>Alt</kbd> + <kbd>9</kbd></td>
          <td>In task</td>
          <td>Toggle qualifier: people</td>
        </tr>
        <tr>
          <td><kbd>Alt</kbd> + <kbd>/</kbd></td>
          <td>In task</td>
          <td>Toggle qualifier: flag</td>
        </tr>
        <tr>
          <td><kbd>Alt</kbd> + <kbd>-</kbd></td>
          <td>In task</td>
          <td>Toggle qualifier: blocked</td>
        </tr>
        <tr>
          <td><kbd>Alt</kbd> + <kbd>0</kbd></td>
          <td>In task</td>
          <td>Clear all qualifiers</td>
        </tr>
        <tr>
          <td><kbd>Alt</kbd> + <kbd>t</kbd></td>
          <td>In task</td>
          <td>Adjusts time tracking to an earlier available slot</td>
        </tr>
        <tr>
          <td><kbd>Alt</kbd> + <kbd>s</kbd></td>
          <td>In task</td>
          <td>Sets the task as selected and show details</td>
        </tr>
        <tr>
          <td><kbd>Alt</kbd> + <kbd>Supr</kbd></td>
          <td>In task</td>
          <td>Sets status cancelled</td>
        </tr>
        <tr>
          <td><kbd>Alt</kbd> + <kbd>b</kbd></td>
          <td>In task</td>
          <td>Moves the task to backlog section</td>
        </tr>
        <tr>
          <td><kbd>Alt</kbd> + <kbd>+</kbd></td>
          <td>In task</td>
          <td>Focus the new task input</td>
        </tr>
        <tr>
          <td><kbd>Alt</kbd> + <kbd>n</kbd></td>
          <td>In task</td>
          <td>Adds task to next task listing</td>
        </tr>
        <tr>
          <td><kbd>Alt</kbd> + <kbd>r</kbd></td>
          <td>In task</td>
          <td>Removes task from next task listing</td>
        </tr>
        <tr>
          <td><kbd>Shift</kbd> + <kbd>F2</kbd></td>
          <td>In task</td>
          <td>
            Stops other tasks in progress, starts time tracking for current task
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div id="optionsMessages"></div>
</div>
<div id="taskDetails" class="tasks-details" *ngIf="state.selected">
  <img
    src="/assets/icons/close.svg"
    class="close-button-img"
    (click)="state.selected = null"
  />
  <strong>Task Details</strong>
  <br />
  <br />
  <div *ngIf="!options.optUsePresentationMode">
    Id: {{ state.selected.tsk_id }}
  </div>
  <div>Name: {{ state.selected.tsk_name }}</div>
  <div *ngIf="!options.optUsePresentationMode">
    <div>Container: {{ state.selected.tsk_id_container }}</div>
    <div>Record: {{ state.selected.tsk_id_record }}</div>
    <div>Parent: {{ state.selected.tsk_parent }}</div>
    <div>Order: {{ state.selected.tsk_order }}</div>
  </div>
  <div>
    Notes:
    <br />
    <div class="grow-wrap">
      <textarea
        spellcheck="false"
        (blur)="setTaskNotes(state.selected, $event)"
      >
{{ state.selected.tsk_notes }}</textarea
      >
      <span *ngIf="state.selected.tsk_notes.length">
        {{ state.selected.tsk_notes.length }} / 4000 characters
      </span>
    </div>
  </div>
  <div *ngIf="state.selected.tsk_date_done">
    Date Done:
    <span
      contenteditable="true"
      spellcheck="false"
      (keyup)="editDateDone(state.selected, $event)"
      >{{ state.selected.tsk_date_done | date: format }}</span
    >
  </div>
  <div *ngIf="state.selected.tsk_total_time_spent">
    Total Time Spent: {{ formatTime(state.selected.tsk_total_time_spent) }}
  </div>
  <div *ngIf="state.selected.tsk_total_time_spent">
    <fieldset *ngIf="state.selected.tsk_time_history.length">
      <legend>Time History</legend>
      <table>
        <tr>
          <td>Sequential</td>
          <td>Name</td>
          <td>Date Start</td>
          <td>Date End</td>
          <td>Time Spent</td>
          <td>User</td>
          <td>Date Add</td>
          <td>Date Mod</td>
          <td>Actions</td>
        </tr>
        <tr *ngFor="let h of state.selected.tsk_time_history">
          <td>{{ h.tsh_num_secuential }}</td>
          <td>{{ h.tsh_name }}</td>
          <td>
            <span
              contenteditable="true"
              spellcheck="false"
              (keyup)="editTimeTracking(h, 1, $event)"
              >{{ h.tsh_date_start | date: format }}</span
            >
          </td>
          <td>
            <span
              contenteditable="true"
              spellcheck="false"
              (keyup)="editTimeTracking(h, 2, $event)"
              >{{ h.tsh_date_end | date: format }}</span
            >
          </td>
          <td>{{ formatTime(h.tsh_time_spent) }}</td>
          <td>{{ h.tsh_id_user }}</td>
          <td>{{ h.tsh_date_add | date: format }}</td>
          <td>{{ h.tsh_date_mod | date: format }}</td>
          <td>
            <button
              *ngIf="h.tsh_date_end"
              (click)="deleteTimeTracking(state.selected, h)"
            >
              delete
            </button>
          </td>
        </tr>
      </table>
    </fieldset>
  </div>
  <div *ngIf="!options.optUsePresentationMode">
    In Progress: {{ state.selected.tsk_ctg_in_process }}
  </div>
  <div *ngIf="state.selected.tsk_qualifiers">
    Qualifiers:
    <span
      contenteditable="true"
      spellcheck="false"
      (blur)="taskQualifiersEdit(state.selected, $event)"
      >{{ state.selected.tsk_qualifiers }}</span
    >
  </div>
  <div *ngIf="state.selected.tsk_tags">
    Tags:
    <span
      contenteditable="true"
      spellcheck="false"
      (blur)="taskTagsEdit(state.selected, $event)"
      >{{ state.selected.tsk_tags }}</span
    >
  </div>
  <div>
    Estimated Duration: {{ formatTime(state.selected.tsk_estimated_duration *
    60, "#h#m") }}
  </div>
  <div *ngIf="!options.optUsePresentationMode">
    <div>
      Schedule Date Start: {{ state.selected.tsk_schedule_date_start | date:
      format }}
    </div>
    <div>
      Schedule Date End: {{ state.selected.tsk_schedule_date_end | date: format
      }}
    </div>
    <div>Date View Until: {{ state.selected.tsk_date_view_until }}</div>
    <div>User Added: {{ state.selected.tsk_id_user_added }}</div>
    <div>User Asigned: {{ state.selected.tsk_id_user_asigned }}</div>
    <div>Date Add: {{ state.selected.tsk_date_add | date: format }}</div>
    <div>Date Last Mod: {{ state.selected.tsk_date_mod | date: format }}</div>
  </div>
  <div *ngIf="!options.optUsePresentationMode">
    Status: {{ state.selected.tsk_ctg_status }}
  </div>
</div>
<div id="backlogTaskList" *ngIf="options.optShowBacklog">
  <hr />
  <button
    class="button-link no-underline"
    (click)="toggleOption('optCollapseBacklog')"
  >
    <strong>{{ options.optCollapseBacklog ? '+' : '-' }} Backlog</strong>
  </button>
  | {{ state.backlogTasks.length }} lists {{ state.backlogTasksCount }} tasks
  <div
    *ngIf="!options.optCollapseBacklog"
    [ngClass]="{
      'task-open-task-list-container': true,
      'task-open-task-list-container--grid': layout === 'grid',
      'task-open-task-list-container--float': layout === 'float'
    }"
  >
    <div
      *ngFor="let item of state.backlogTasks"
      class="task-record"
      [ngClass]="{
        'hidden': item.collapsed
      }"
    >
      <div>
        <button
          class="button-link no-underline"
          (click)="toggleCollapsedRecord(item, true)"
        >
          <strong>- {{ item.header }}</strong>
        </button>
        ({{ formatTime(item.estimatedDuration * 60) }})
      </div>
      <div
        class="task-record-items"
        [ngClass]="{
          'task-record-custom-size': options.optRecordWidth !== defaultOptions.optRecordWidth || options.optRecordHeight !== defaultOptions.optRecordHeight
        }"
        [ngStyle]="{
          'max-width': (options.optRecordWidth !== defaultOptions.optRecordWidth || options.optRecordHeight !== defaultOptions.optRecordHeight) ? options.optRecordWidth + 'px' : defaultOptions.optRecordWidth,
          'max-height': (options.optHideScrollbarsInRecord ? 'initial' : (options.optRecordWidth !== defaultOptions.optRecordWidth || options.optRecordHeight !== defaultOptions.optRecordHeight) ? options.optRecordHeight + 'px' : defaultOptions.optRecordHeight)
        }"
      >
        <task
          *ngFor="let t of item.tasks"
          [task]="t"
          [groupTasks]="item.tasks"
          containerSelector="#backlogTaskList"
          [handlers]="handlersForBacklog"
          [options]="{
          optShowRecordNameInline: true,
          optShowBadgeIfTaskIsInBacklog: true
        }"
          [ngClass]="{
          hidden:
            options.optShowLimitedTasksPerRecord &&
            options.optLimitTasksPerRecord &&
            i >= 3 &&
            t.tsk_time_history.length === 0
        }"
          [ngStyle]="{
          'font-size-2': ageFontSizeNormalization(t) + 'px'
        }"
        ></task>
      </div>
    </div>
  </div>
</div>
<div id="postponedTaskList" *ngIf="viewPostponed">
  <strong>Postponed Tasks</strong>
  <div *ngFor="let t of state.postponedTasks">
    -
    <span *ngIf="t.tsk_total_time_spent !== 0"
      >[{{ t.tsk_time_history.length }}/{{ formatTime(t.tsk_total_time_spent)
      }}]</span
    >
    <span
      contenteditable="true"
      spellcheck="false"
      (keyup)="taskEdit(t, $event)"
      [ngClass]="{
        'task-done': t.tsk_ctg_status === this.taskStatus.CLOSED,
        'task-in-process': t.tsk_ctg_in_process === 2,
        'task-important': t.tsk_qualifiers.indexOf('important') !== -1,
        'task-urgent': t.tsk_qualifiers.indexOf('urgent') !== -1,
        'task-q-progressed': t.tsk_qualifiers.indexOf('progressed') !== -1
      }"
      (blur)="commandOnTask(t, $event)"
      class="editable"
      >{{ t.tsk_name }}</span
    >
    <span
      contenteditable="true"
      spellcheck="false"
      (blur)="taskEstimatedDurationEdit(t, $event)"
      [ngClass]="{ 'task-no-eta': t.tsk_estimated_duration === 0 }"
      class="task-eta"
      >{{ formatTime(t.tsk_estimated_duration * 60, "#h#m") }}</span
    >
    <span *ngIf="t.tsk_schedule_date_start"
      >(start at {{ formatDateTime(t.tsk_schedule_date_start) }})</span
    >
    <span [ngClass]="taskAgeClass(t)">{{ taskAge(t) }}</span>
    <span
      >(postponed until {{ t.tsk_date_view_until | date: "yyyy-MM-dd HH:mm:ss"
      }})</span
    >
    <button (click)="setSelected(t)">details</button>
    <button (click)="setUnpostpone(t)">see it now</button>
  </div>
  <hr />
</div>
<div id="openTaskList">
  <hr />
  <span>
    <button
      class="button-link no-underline"
      (click)="toggleOption('optCollapseOpenTasks')"
    >
      <strong>{{ options.optCollapseOpenTasks ? '+' : '-' }} Open Tasks</strong>
    </button>
    | {{ state.openTasks.length }} lists {{ state.openTasksCount }} tasks
    <span *ngIf="options.optShowSyncButton && !options.optCollapseOpenTasks">
      <button (click)="syncTasks()">sync tasks</button>
    </span>
    <span
      *ngIf="options.optShowCollapseRecords && !options.optCollapseOpenTasks"
    >
      <button (click)="toggleCollapseAllRecords(true)">Collapse all</button>
      <button (click)="toggleCollapseAllRecords(false)">Expand all</button>
    </span>
    <span
      class="padding-left-5 padding-right-5"
      *ngIf="options.optShowFilter && !options.optCollapseOpenTasks"
    >
      Filter
      <select
        name="fFilter"
        id="fFilter"
        class="field-select"
        [(ngModel)]="viewData.selectedFilter"
        (change)="updateState()"
      >
        <option
          *ngFor="let opt of CONSTANTS.filters"
          [value]="opt.id"
          [selected]="opt.id === viewData.selectedFilter"
        >
          {{ opt.name }}
        </option>
      </select>
    </span>
  </span>
  <div *ngIf="!state.openTasks.length">
    <strong
      >No tasks open! Congratulations! Consider reviewing the backlog or add new
      tasks to do.</strong
    >
  </div>
  <div
    *ngIf="!options.optCollapseOpenTasks"
    [ngClass]="{
      'task-open-task-list-container': true,
      'task-open-task-list-container--grid': layout === 'grid',
      'task-open-task-list-container--float': layout === 'float'
    }"
  >
    <div class="task-record-collapsed display-block">
      <div
        *ngFor="let item of state.openTasks"
        class="task-record"
        [ngClass]="{
          'task-record-no-task-done': options.optColorizeRecordWithoutDoneTasks && countTasksDone(item.header) === 0,
          'hidden': !item.collapsed
        }"
      >
        <div *ngIf="item.collapsed">
          <button
            class="button-link no-underline"
            (click)="toggleCollapsedRecord(item, false)"
          >
            <strong>+ {{ item.header }}</strong>
          </button>
          | {{ item.tasks.length }} ({{ formatTimestamp(item.estimatedDuration *
          60) }})
          <span *ngIf="countTasksDone(item.header) > 0">
            |
            <span
              class="task-done"
              title="tasks done today from this record list"
            >
              {{ countTasksDone(item.header) }}
            </span>
          </span>
        </div>
      </div>
    </div>
    <div
      *ngFor="let item of state.openTasks"
      class="task-record"
      [ngClass]="{
        'task-record-no-task-done': options.optColorizeRecordWithoutDoneTasks && countTasksDone(item.header) === 0,
        'hidden': item.collapsed,
        'task-record-background': isRecordPinned(item.header)
      }"
      [ngStyle]="{
        'max-width': options.optUseColumnsForRecords || (isRecordPinned(item.header) && item.tasks.length >= 20) ? '100%' : undefined
      }"
    >
      <div
        [ngStyle]="{
        'display': 'flex',
        'justify-content': 'space-between'
      }"
      >
        <span>
          <button
            class="button-link no-underline"
            (click)="toggleCollapsedRecord(item, true)"
          >
            <strong>- {{ item.header }}</strong>
          </button>
          | {{ item.tasks.length }} ({{ formatTimestamp(item.estimatedDuration *
          60) }})
          <span *ngIf="countTasksDone(item.header) > 0">
            |
            <span
              class="task-done"
              title="tasks done today from this record list"
            >
              {{ countTasksDone(item.header) }}
            </span>
          </span>
        </span>
        <span
          (click)="togglePinRecord(item.header)"
          [ngStyle]="{
          'cursor': 'pointer',
          'border': isRecordPinned(item.header) ? '1px solid grey' : '0'
        }"
        >
          ðŸ“Œ
        </span>
      </div>
      <div
        class="task-record-items"
        [ngClass]="{
          'task-record-custom-size': options.optRecordWidth !== defaultOptions.optRecordWidth || options.optRecordHeight !== defaultOptions.optRecordHeight,
          'task-record-use-columns': (options.optUseColumnsForRecords || isRecordPinned(item.header)) && item.tasks.length >= 20
        }"
        [ngStyle]="{
          'max-width': recordStyle(item.header, 'width'),
          'max-height': recordStyle(item.header, 'height')
        }"
      >
        <div
          *ngFor="let t of item.tasks; let i = index"
          data-id="{{ t.tsk_id }}"
          [ngStyle]="{
            'font-size-2': ageFontSizeNormalization(t) + 'px'
          }"
          [ngClass]="{
            hidden:
              options.optShowLimitedTasksPerRecord &&
              options.optLimitTasksPerRecord &&
              i >= 3 &&
              t.tsk_time_history.length === 0
          }"
        >
          <input
            type="checkbox"
            id="{{ t.tsk_id }}"
            (click)="taskCheckboxHandler(t, $event)"
          />
          <span
            *ngIf="t.tsk_total_time_spent !== 0"
            [ngClass]="{
              'task-open-with-tt':
                t.tsk_ctg_status === this.taskStatus.OPEN &&
                t.tsk_time_history.length > 0
            }"
            >[{{ t.tsk_time_history.length }}/{{
            formatTime(t.tsk_total_time_spent) }}]
            <span *ngIf="t.tsk_ctg_in_process !== 2">
              [<span
                class="tt-start"
                contenteditable="true"
                spellcheck="false"
                (keyup)="timeTrackingQuickEdit(t, $event, 'start')"
                >{{ t.tsk_time_history[t.tsk_time_history.length - 1]
                .tsh_date_start | date: "HH:mm:ss" }}</span
              >
              -
              <span
                class="tt-end"
                contenteditable="true"
                spellcheck="false"
                (keyup)="timeTrackingQuickEdit(t, $event, 'end')"
                >{{ t.tsk_time_history[t.tsk_time_history.length -
                1].tsh_date_end | date: "HH:mm:ss" }}</span
              >]
            </span>
          </span>
          <span *ngIf="t.tsk_ctg_in_process === 2"
            >[<span
              contenteditable="true"
              spellcheck="false"
              (keyup)="timeTrackingQuickEdit(t, $event, 'start')"
              >{{ t.tsk_time_history[t.tsk_time_history.length -
              1].tsh_date_start | date: "HH:mm:ss" }}</span
            >]
          </span>
          <span
            *ngIf="t.tsk_ctg_in_process === 2"
            (click)="toggleTimeMode()"
            class="clickable"
            title="click to toggle timer mode"
          >
            {{ timers[t.tsk_id] ? "[" + timers[t.tsk_id].timerString + "]" : ""
            }}
          </span>
          <span
            class="task-qualifier-icon"
            *ngIf="t.tsk_qualifiers.indexOf('star') !== -1"
            >&#9733;</span
          >
          <span
            class="task-qualifier-icon task-qualifier-urgent"
            *ngIf="t.tsk_qualifiers.indexOf('urgent') !== -1"
            >&#33;</span
          >
          <span
            class="task-qualifier-icon"
            *ngIf="t.tsk_qualifiers.indexOf('people') !== -1"
          >
            <img
              src="/assets/icons/people.svg"
              alt="Requires reaching out people"
              title="Requires reaching out people"
            />
          </span>
          <span
            class="task-qualifier-icon"
            *ngIf="t.tsk_qualifiers.indexOf('mobile') !== -1"
          >
            <img
              src="/assets/icons/smartphone.svg"
              alt="Can be done using phone"
              title="Can be done using phone"
            />
          </span>
          <span
            class="task-qualifier-icon task-qualifier-flag"
            *ngIf="t.tsk_qualifiers.indexOf('flag') !== -1"
            >&#9873;</span
          >
          <span
            class="task-qualifier-icon"
            *ngIf="t.tsk_qualifiers.indexOf('blocked') !== -1"
            >&#10006;</span
          >
          <span class="task-next-todo-icon" *ngIf="t.inNextToDo">
            <img
              src="/assets/icons/energy.svg"
              alt="In Next To Do Today listing"
              title="In Next To Do Today listing"
            />
          </span>
          <span class="task-pinned-todo-icon" *ngIf="t.inPinnedToDo">
            <img
              src="/assets/icons/energy.svg"
              alt="In Pinned To Do listing"
              title="In Pinned To Do listing"
            />
          </span>
          <span
            contenteditable="true"
            spellcheck="false"
            (keyup)="taskEdit(t, $event)"
            [ngClass]="{
              'task-done': t.tsk_ctg_status === this.taskStatus.CLOSED,
              'task-in-process': t.tsk_ctg_in_process === 2,
              'task-highlighted': t.tsk_qualifiers.indexOf('highlighted') !== -1,
              'task-priority': t.tsk_qualifiers.indexOf('priority') !== -1,
              'task-important': t.tsk_qualifiers.indexOf('important') !== -1,
              'task-unexpected': t.tsk_qualifiers.indexOf('unexpected') !== -1,
              'task-q-progressed': t.tsk_qualifiers.indexOf('progressed') !== -1,
              'task-directions': t.tsk_qualifiers.indexOf('directions') !== -1,
              'task-critical': t.tsk_qualifiers.indexOf('critical') !== -1
            }"
            (blur)="commandOnTask(t, $event)"
            (focus)="setFocus(t, $event); setTaskSelected(t)"
            (keydown)="taskKeyDown($event)"
            tabindex="0"
            class="editable task-text"
            >{{ t.tsk_name }}</span
          >
          <span class="task-link" *ngIf="t.tsk_url"
            >&nbsp;<a
              href="{{ t.tsk_url }}"
              title="{{ t.tsk_url }}"
              target="_blank"
              >link</a
            ></span
          ><span
            [attr.contenteditable]="options.optAllowToEditETA"
            spellcheck="false"
            (blur)="taskEstimatedDurationEdit(t, $event)"
            (keydown)="etaKeyDown($event)"
            [ngClass]="{ 'task-no-eta': t.tsk_estimated_duration === 0 }"
            class="task-eta"
            >{{ formatTime(t.tsk_estimated_duration * 60, "#h#m") }}</span
          >
          <span *ngIf="t.tsk_tags" class="task-tags"
            >&nbsp;<span
              *ngFor="let tag of t.tsk_tags.split(' ')"
              (click)="showTagStats(tag)"
              class="tag"
              >#{{ tag }}</span
            >
          </span>
          <span *ngIf="t.tsk_schedule_date_start"
            ><strong
              >&nbsp;at {{ formatDateTime(t.tsk_schedule_date_start) }}
              &#9200;</strong
            ></span
          >&nbsp;<span
            [ngClass]="taskAgeClass(t)"
            *ngIf="options.optViewElapsedDays"
            >{{ taskAge(t) }}</span
          >
          <span *ngIf="t.not_sync">&#8634;</span>
        </div>
      </div>
    </div>
  </div>
</div>
<br />
<div id="Info">
  <hr />
  Total Tasks: {{ tasks.length }} | Backlog: {{ state.backlogTasksCount }}
  <span *ngIf="state.postponedTasksCount">
    | Postponed: {{ state.postponedTasksCount }}
  </span>
  <div *ngIf="!options.optUsePresentationMode">
    Karma Score:
    <span
      >{{ state.karmaScore }} ({{ state.karmaCount }} / {{
      state.closedTodayTasks.length }})</span
    >
    <br />Tasks not in sync: {{ services.sync.queue.length }} <br /><strong
      >{{ isOnline() ? "" : "You are OFFLINE" }}</strong
    >
  </div>
  <div *ngIf="options.optShowIndicatorsTable" class="task-indicators-container">
    <div>
      <button
        class="button-link no-underline"
        (click)="toggleOption('optCollapseIndicators')"
      >
        <strong
          >{{ options.optCollapseIndicators ? '+' : '-' }} Indicators</strong
        >
      </button>
    </div>
    <table class="indicators-table" *ngIf="!options.optCollapseIndicators">
      <tr>
        <td>Indicator</td>
        <td
          *ngFor="let c of state.indicatorLabels; let currIndex = index"
          [ngClass]="{
          'desktop-only': currIndex < 3
        }"
        >
          {{ c }}
        </td>
        <td class="text-align-center">%</td>
      </tr>
      <tr *ngFor="let indicator of state.indicators">
        <td>
          <span> {{ indicator.name }} </span>
          <span *ngIf="indicator.metric === 'MORE_IS_BETTER'"> &uarr; </span>
          <span *ngIf="indicator.metric === 'LESS_IS_BETTER'"> &darr; </span>
        </td>
        <td
          *ngFor="let v of indicator.formattedValues; let currIndex = index"
          [ngClass]="{
          'desktop-only': currIndex < 3
        }"
        >
          <span
            [ngClass]="{'color-green': currIndex > 0 && (indicator.values[currIndex - 1] < indicator.values[currIndex] && indicator.metric === 'MORE_IS_BETTER' || indicator.values[currIndex - 1] > indicator.values[currIndex] && indicator.metric === 'LESS_IS_BETTER'),
          'color-red': currIndex > 0 && (indicator.values[currIndex - 1] > indicator.values[currIndex] && indicator.metric === 'MORE_IS_BETTER' || indicator.values[currIndex - 1] < indicator.values[currIndex] && indicator.metric === 'LESS_IS_BETTER')}"
          >
            {{ v }}
          </span>
        </td>
        <td>{{ indicator.percentageCompleted }}</td>
      </tr>
    </table>
  </div>
</div>
<div id="nextToDoTodayList" *ngIf="nextTasks[0].tasks.length">
  <hr />
  <div class="task-open-task-list-container">
    <div *ngFor="let item of nextTasks" class="task-record">
      <div>
        <button
          class="button-link no-underline"
          (click)="toggleOption('optCollapseNextTasks')"
        >
          <strong
            >{{ options.optCollapseNextTasks ? '+' : '-' }} Next To Do
            Today</strong
          >
        </button>
        | {{ item.tasks.length }}
        <time-format
          format="([H]h[m]m)"
          [value]="item.estimatedDuration"
        ></time-format>
        |
        <time-format
          format="([H]h[m]m)"
          [value]="differenceLastClosedToRealTime"
          title="Time ahead/behind of the last task closed"
          [ngClass]="{
            'task-next-time-ahead': differenceLastClosedToRealTime < 0,
            'task-next-time-behind': 0 <= differenceLastClosedToRealTime
          }"
        ></time-format>
      </div>
      <div
        *ngIf="!options.optCollapseNextTasks"
        [ngClass]="{
        'columns-3': nextTasks[0].tasks.length > 10
      }"
      >
        <div
          *ngFor="let t of item.tasks; let count = index"
          data-id="{{ t.tsk_id }}"
          [ngClass]="{
            'task-item-in-process': t.tsk_ctg_in_process === 2
          }"
        >
          <hr
            *ngIf="t['projectedDate'].getHours() < 2 && count > 0 && item.tasks[count-1]['projectedDate'].getHours() >= 23"
          />
          <input
            type="checkbox"
            id="{{ t.tsk_id }}"
            (click)="taskCheckboxHandler(t, $event)"
          />
          <span
            [ngClass]="{
            'task-next-time-ahead': count === 0 && t['projectedDate'].getTime() >= getDate().getTime(),
            'task-next-time-behind': count === 0 && getDate().getTime() > t['projectedDate'].getTime()
          }"
            >&lt;{{t['projectedDate'] | date: "HH:mm"}}&gt;
          </span>
          <span
            *ngIf="t.tsk_total_time_spent !== 0"
            [ngClass]="{
              'task-open-with-tt':
                t.tsk_ctg_status === this.taskStatus.OPEN &&
                t.tsk_time_history.length > 0
            }"
            >[{{ t.tsk_time_history.length }}/{{
            formatTime(t.tsk_total_time_spent) }}]
            <span *ngIf="t.tsk_ctg_in_process !== 2">
              [<span
                class="tt-start"
                contenteditable="true"
                spellcheck="false"
                (keyup)="timeTrackingQuickEdit(t, $event, 'start')"
                >{{ t.tsk_time_history[t.tsk_time_history.length - 1]
                .tsh_date_start | date: "HH:mm:ss" }}</span
              >
              -
              <span
                class="tt-end"
                contenteditable="true"
                spellcheck="false"
                (keyup)="timeTrackingQuickEdit(t, $event, 'end')"
                >{{ t.tsk_time_history[t.tsk_time_history.length -
                1].tsh_date_end | date: "HH:mm:ss" }}</span
              >]
            </span>
          </span>
          <span *ngIf="t.tsk_ctg_in_process === 2">
            [<span
              contenteditable="true"
              spellcheck="false"
              (keyup)="timeTrackingQuickEdit(t, $event, 'start')"
              >{{ t.tsk_time_history[t.tsk_time_history.length -
              1].tsh_date_start | date: "HH:mm:ss" }}</span
            >]
          </span>
          <span
            (click)="toggleTimeMode()"
            class="clickable"
            title="click to toggle timer mode"
          >
            {{ timers[t.tsk_id] ? "[" + timers[t.tsk_id].timerString + "]" : ""
            }}
          </span>
          <span
            class="task-qualifier-icon"
            *ngIf="t.tsk_qualifiers.indexOf('star') !== -1"
            >&#9733;</span
          >
          <span
            class="task-qualifier-icon task-qualifier-urgent"
            *ngIf="t.tsk_qualifiers.indexOf('urgent') !== -1"
            >&#33;</span
          >
          <span
            class="task-qualifier-icon"
            *ngIf="t.tsk_qualifiers.indexOf('people') !== -1"
          >
            <img
              src="/assets/icons/people.svg"
              alt="Requires reaching out people"
              title="Requires reaching out people"
            />
          </span>
          <span
            class="task-qualifier-icon"
            *ngIf="t.tsk_qualifiers.indexOf('mobile') !== -1"
          >
            <img
              src="/assets/icons/smartphone.svg"
              alt="Can be done using phone"
              title="Can be done using phone"
            />
          </span>
          <span
            class="task-qualifier-icon task-qualifier-flag"
            *ngIf="t.tsk_qualifiers.indexOf('flag') !== -1"
            >&#9873;</span
          >
          <span
            class="task-qualifier-icon"
            *ngIf="t.tsk_qualifiers.indexOf('blocked') !== -1"
            >&#10006;</span
          >
          <span
            contenteditable="true"
            spellcheck="false"
            (keyup)="taskEdit(t, $event)"
            (keydown)="nextTaskKeyDown($event)"
            [ngClass]="{
              'task-done': t.tsk_ctg_status === this.taskStatus.CLOSED,
              'task-in-process': t.tsk_ctg_in_process === 2,
              'task-important': t.tsk_qualifiers.indexOf('important') !== -1,
              'task-urgent': t.tsk_qualifiers.indexOf('urgent') !== -1,
              'task-highlighted': t.tsk_qualifiers.indexOf('highlighted') !== -1,
              'task-q-progressed': t.tsk_qualifiers.indexOf('progressed') !== -1,
              'task-unexpected': t.tsk_qualifiers.indexOf('unexpected') !== -1,
              'task-call': t.tsk_qualifiers.indexOf('call') !== -1,
              'task-priority': t.tsk_qualifiers.indexOf('priority') !== -1,
              'task-directions': t.tsk_qualifiers.indexOf('directions') !== -1,
              'task-critical': t.tsk_qualifiers.indexOf('critical') !== -1
            }"
            (blur)="commandOnTask(t, $event)"
            class="editable task-text"
            >{{ t.tsk_name }}</span
          >&nbsp;<span
            [attr.contenteditable]="options.optAllowToEditETA"
            spellcheck="false"
            (blur)="taskEstimatedDurationEdit(t, $event)"
            [ngClass]="{ 'task-no-eta': t.tsk_estimated_duration === 0 }"
            class="task-eta"
            >{{ formatTime(t.tsk_estimated_duration * 60, "#h#m") }}</span
          ><span> [{{t.tsk_id_record}}] </span>
          <span *ngIf="t.tsk_tags" class="task-tags">
            <span
              *ngFor="let tag of t.tsk_tags.split(' ')"
              (click)="showTagStats(tag)"
              class="tag"
            >
              #{{ tag }}
            </span>
          </span>
          <span *ngIf="t.tsk_schedule_date_start"
            ><strong
              >(start at {{ formatDateTime(t.tsk_schedule_date_start)
              }})</strong
            ></span
          >
          <span [ngClass]="taskAgeClass(t)" *ngIf="options.optViewElapsedDays"
            >{{ taskAge(t) }}</span
          >
          <span *ngIf="t.not_sync">(Not in sync)</span>
        </div>
      </div>
    </div>
  </div>
</div>
<div id="pinnedToDoTodayList" *ngIf="pinnedTasks[0].tasks.length">
  <hr />
  <div class="task-open-task-list-container">
    <div *ngFor="let item of pinnedTasks" class="task-record">
      <div>
        <button
          class="button-link no-underline"
          (click)="toggleOption('optCollapsePinnedTasks')"
        >
          <strong
            >{{ options.optCollapsePinnedTasks ? '+' : '-' }} Pinned To
            Do</strong
          >
        </button>
        | {{ item.tasks.length }}
        <time-format
          format="([H]h[m]m)"
          [value]="item.estimatedDuration"
        ></time-format>
      </div>
      <div
        *ngIf="!options.optCollapsePinnedTasks"
        [ngClass]="{
        'columns-3': pinnedTasks[0].tasks.length > 10
      }"
      >
        <div
          *ngFor="let t of item.tasks; let count = index"
          data-id="{{ t.tsk_id }}"
        >
          <input
            type="checkbox"
            id="{{ t.tsk_id }}"
            (click)="taskCheckboxHandler(t, $event)"
          />
          <span
            *ngIf="t.tsk_total_time_spent !== 0"
            [ngClass]="{
              'task-open-with-tt':
                t.tsk_ctg_status === this.taskStatus.OPEN &&
                t.tsk_time_history.length > 0
            }"
            >[{{ t.tsk_time_history.length }}/{{
            formatTime(t.tsk_total_time_spent) }}]
            <span *ngIf="t.tsk_ctg_in_process !== 2">
              [<span
                class="tt-start"
                contenteditable="true"
                spellcheck="false"
                (keyup)="timeTrackingQuickEdit(t, $event, 'start')"
                >{{ t.tsk_time_history[t.tsk_time_history.length - 1]
                .tsh_date_start | date: "HH:mm:ss" }}</span
              >
              -
              <span
                class="tt-end"
                contenteditable="true"
                spellcheck="false"
                (keyup)="timeTrackingQuickEdit(t, $event, 'end')"
                >{{ t.tsk_time_history[t.tsk_time_history.length -
                1].tsh_date_end | date: "HH:mm:ss" }}</span
              >]
            </span>
          </span>
          <span *ngIf="t.tsk_ctg_in_process === 2">
            [<span
              contenteditable="true"
              spellcheck="false"
              (keyup)="timeTrackingQuickEdit(t, $event, 'start')"
              >{{ t.tsk_time_history[t.tsk_time_history.length -
              1].tsh_date_start | date: "HH:mm:ss" }}</span
            >]
          </span>
          <span
            (click)="toggleTimeMode()"
            class="clickable"
            title="click to toggle timer mode"
          >
            {{ timers[t.tsk_id] ? "[" + timers[t.tsk_id].timerString + "]" : ""
            }}
          </span>
          <span
            class="task-qualifier-icon"
            *ngIf="t.tsk_qualifiers.indexOf('star') !== -1"
            >&#9733;</span
          >
          <span
            class="task-qualifier-icon task-qualifier-urgent"
            *ngIf="t.tsk_qualifiers.indexOf('urgent') !== -1"
            >&#33;</span
          >
          <span
            class="task-qualifier-icon"
            *ngIf="t.tsk_qualifiers.indexOf('people') !== -1"
          >
            <img
              src="/assets/icons/people.svg"
              alt="Requires reaching out people"
              title="Requires reaching out people"
            />
          </span>
          <span
            class="task-qualifier-icon"
            *ngIf="t.tsk_qualifiers.indexOf('mobile') !== -1"
          >
            <img
              src="/assets/icons/smartphone.svg"
              alt="Can be done using phone"
              title="Can be done using phone"
            />
          </span>
          <span
            class="task-qualifier-icon task-qualifier-flag"
            *ngIf="t.tsk_qualifiers.indexOf('flag') !== -1"
            >&#9873;</span
          >
          <span
            class="task-qualifier-icon"
            *ngIf="t.tsk_qualifiers.indexOf('blocked') !== -1"
            >&#10006;</span
          >
          <span
            contenteditable="true"
            spellcheck="false"
            (keyup)="taskEdit(t, $event)"
            (keydown)="pinnedTaskKeyDown($event)"
            [ngClass]="{
              'task-done': t.tsk_ctg_status === this.taskStatus.CLOSED,
              'task-in-process': t.tsk_ctg_in_process === 2,
              'task-important': t.tsk_qualifiers.indexOf('important') !== -1,
              'task-urgent': t.tsk_qualifiers.indexOf('urgent') !== -1,
              'task-highlighted': t.tsk_qualifiers.indexOf('highlighted') !== -1,
              'task-q-progressed': t.tsk_qualifiers.indexOf('progressed') !== -1,
              'task-unexpected': t.tsk_qualifiers.indexOf('unexpected') !== -1,
              'task-call': t.tsk_qualifiers.indexOf('call') !== -1,
              'task-priority': t.tsk_qualifiers.indexOf('priority') !== -1,
              'task-directions': t.tsk_qualifiers.indexOf('directions') !== -1,
              'task-critical': t.tsk_qualifiers.indexOf('critical') !== -1
            }"
            (blur)="commandOnTask(t, $event)"
            class="editable task-text"
            >{{ t.tsk_name }}</span
          >&nbsp;<span
            [attr.contenteditable]="options.optAllowToEditETA"
            spellcheck="false"
            (blur)="taskEstimatedDurationEdit(t, $event)"
            [ngClass]="{ 'task-no-eta': t.tsk_estimated_duration === 0 }"
            class="task-eta"
            >{{ formatTime(t.tsk_estimated_duration * 60, "#h#m") }}</span
          ><span> [{{t.tsk_id_record}}] </span>
          <span *ngIf="t.tsk_tags" class="task-tags">
            <span
              *ngFor="let tag of t.tsk_tags.split(' ')"
              (click)="showTagStats(tag)"
              class="tag"
            >
              #{{ tag }}
            </span>
          </span>
          <span *ngIf="t.tsk_schedule_date_start"
            ><strong
              >(start at {{ formatDateTime(t.tsk_schedule_date_start)
              }})</strong
            ></span
          >
          <span [ngClass]="taskAgeClass(t)" *ngIf="options.optViewElapsedDays"
            >{{ taskAge(t) }}</span
          >
          <span *ngIf="t.not_sync">(Not in sync)</span>
        </div>
      </div>
    </div>
  </div>
</div>
<div id="tagInfo" *ngIf="tagInfo.display === true">
  <button (click)="tagInfo.display = false">hide</button>
  <strong>Tag Information</strong>
  <br />Closed Tasks | Estimated: {{
  formatTime(tagInfo.tasksClosedTotalEstimated * 60) }} | Spent: {{
  formatTime(tagInfo.tasksClosedTotalSpent) }} <br />Open Tasks | Estimated: {{
  formatTime(tagInfo.tasksOpenTotalEstimated * 60) }} | Spent: {{
  formatTime(tagInfo.tasksOpenTotalSpent) }}
  <div *ngIf="tagInfo.tasks.length > 0">
    <table>
      <tr>
        <td>Name</td>
        <td>Estimated</td>
        <td>Spent</td>
        <td>Status</td>
        <td>Actions</td>
      </tr>
      <tr *ngFor="let e of tagInfo.tasks">
        <td>{{ e.tsk_name }}</td>
        <td>{{ formatTime(e.tsk_estimated_duration * 60) }}</td>
        <td>{{ formatTime(e.tsk_total_time_spent) }}</td>
        <td>{{ statusText(e.tsk_ctg_status) }}</td>
        <td><button (click)="setSelected(e)">details</button></td>
      </tr>
    </table>
  </div>
  <hr />
</div>
<div *ngIf="options.optShowFinishedToday">
  <hr />
  <button
    class="button-link no-underline"
    (click)="toggleOption('optCollapseFinishedToday')"
  >
    <strong
      >{{ options.optCollapseFinishedToday ? '+' : '-' }} Finished Today</strong
    >
  </button>
  | {{ state.closedTodayTasks.length }} tasks
  <div *ngIf="!options.optCollapseFinishedToday">
    <div *ngFor="let item of state.closedTodayTasks; let i = index">
      <div *ngIf="i < 3 || viewAllFinishedToday">
        <input
          type="checkbox"
          id="{{ item.tsk_id }}"
          checked
          (click)="taskCheckboxHandler(item, $event)"
        />
        <span
          *ngIf="item.tsk_total_time_spent !== 0"
          [ngClass]="{
            'task-open-with-tt':
              item.tsk_ctg_status === this.taskStatus.OPEN &&
              item.tsk_time_history.length > 0
          }"
          >[{{ item.tsk_time_history.length }}/{{
          formatTime(item.tsk_total_time_spent) }}]
          <span *ngIf="item.tsk_ctg_in_process !== 2">
            [<span
              class="tt-start"
              contenteditable="true"
              spellcheck="false"
              (keyup)="timeTrackingQuickEdit(item, $event, 'start')"
              >{{ item.tsk_time_history[item.tsk_time_history.length - 1] &&
              item.tsk_time_history[item.tsk_time_history.length - 1]
              .tsh_date_start | date: "HH:mm:ss" }}</span
            >
            -
            <span
              class="tt-end"
              contenteditable="true"
              spellcheck="false"
              (keyup)="timeTrackingQuickEdit(item, $event, 'end')"
              >{{ item.tsk_time_history[item.tsk_time_history.length - 1] &&
              item.tsk_time_history[item.tsk_time_history.length - 1]
              .tsh_date_end | date: "HH:mm:ss" }}</span
            >]
          </span>
        </span>
        <span
          >(Done at:
          <span
            contenteditable="true"
            spellcheck="false"
            (keyup)="editDateDone(item, $event)"
            >{{ item.tsk_date_done | date: format }}</span
          >)</span
        >&nbsp;<span
          [ngClass]="{
            'task-done': item.tsk_ctg_status === this.taskStatus.CLOSED
          }"
          >{{ item.tsk_name }}</span
        >
        <span *ngIf="item.not_sync">(Not in sync)</span>&nbsp;<button
          (click)="setSelected(item)"
        >
          details
        </button>
      </div>
    </div>
    <button
      (click)="toggleView('viewAllFinishedToday')"
      *ngIf="state.closedTodayTasks.length > 3"
    >
      {{ viewAllFinishedToday ? "Do not show all" : "Show all" }}
    </button>
  </div>
</div>
<div *ngIf="options.optShowFinishedYesterday">
  <hr />
  <button
    class="button-link no-underline"
    (click)="toggleOption('optCollapseFinishedYesterday')"
  >
    <strong
      >{{ options.optCollapseFinishedYesterday ? '+' : '-' }} Finished
      Yesterday</strong
    >
  </button>
  | {{ state.closedYesterdayTasks.length }} tasks
  <div *ngIf="!options.optCollapseFinishedYesterday">
    <div *ngFor="let item of state.closedYesterdayTasks; let i = index">
      <div *ngIf="i < 3 || viewAllFinishedYesterday">
        <task
          [task]="item"
          [handlers]="handlersForClosedYesterday"
          [options]="{
            optShowRecordNameInline: true,
            optShowTimeTrackingHistory: true,
            optShowDetailsButton: true
        }"
        ></task>
      </div>
    </div>
    <button
      (click)="toggleView('viewAllFinishedYesterday')"
      *ngIf="state.closedYesterdayTasks.length > 3"
    >
      {{ viewAllFinishedYesterday ? "Do not show all" : "Show all" }}
    </button>
  </div>
</div>
<div id="closedTaskList" *ngIf="options.optShowClosedTasks">
  <hr />
  <button
    class="button-link no-underline"
    (click)="toggleOption('optCollapseClosedTasks')"
  >
    <strong
      >{{ options.optCollapseClosedTasks ? '+' : '-' }} Closed Tasks</strong
    >
  </button>
  <div *ngIf="!options.optCollapseClosedTasks">
    <div *ngFor="let group of state.closedTasks">
      <div>
        <br />
        <strong>{{ group.header | date: "yyyy-MM-dd" }}</strong>
        &nbsp;<span>(Spent {{ formatTime(group.totalTimeSpent) }})</span>
      </div>
      <div *ngFor="let item of group.tasks">
        -
        <span
          >[{{ item.tsk_time_history.length }}/{{
          formatTime(item.tsk_total_time_spent) }}]</span
        >
        <span>[{{ item.tsk_id_record }}]</span>
        <span>{{ item.tsk_name }}</span>
        <!--<span
          >(done at {{ item.tsk_date_done | date: "yyyy-MM-dd HH:mm:ss"
          }})</span
        >-->
        <span *ngIf="item.tsk_tags" class="task-tags">
          <span
            *ngFor="let tag of item.tsk_tags.split(' ')"
            (click)="showTagStats(tag)"
            class="tag"
          >
            #{{ tag }}
          </span>
        </span>
        &nbsp;<button (click)="setSelected(item)">details</button>
      </div>
    </div>
  </div>
</div>
<div *ngIf="options.optShowReportsWeekDistribution">
  <hr />
  <button
    class="button-link no-underline"
    (click)="toggleOption('optCollapseReportsWeekDistribution')"
  >
    <strong
      >{{ options.optCollapseReportsWeekDistribution ? '+' : '-' }} Week
      Distribution Report</strong
    >
  </button>
  <div *ngIf="!options.optCollapseReportsWeekDistribution">
    <div *ngFor="let s of reports.week">
      date: {{ s.date | date: "yyyy-MM-dd" }} tasks done: {{ s.tasksDone }}
      estimated: {{ formatTime(s.estimated * 60) }} spent: {{
      formatTime(s.timeSpent) }} Productivity: {{ s.productivity }} Real Time
      Elapsed: {{ formatTime(s.realTimeElapsed) }}
    </div>
  </div>
</div>
<div *ngIf="options.optShowReportsDayDistribution">
  <hr />
  <button
    class="button-link no-underline"
    (click)="toggleOption('optCollapseReportsDayDistribution')"
  >
    <strong
      >{{ options.optCollapseReportsDayDistribution ? '+' : '-' }} Day
      Distribution Report</strong
    >
  </button>
  <div *ngIf="!options.optCollapseReportsDayDistribution">
    <table>
      <tr>
        <td>Record</td>
        <td>Total ETA</td>
        <td>Total Real</td>
        <td>Percentage ETA</td>
        <td>Percentage Real</td>
      </tr>
      <tr *ngFor="let r of reports.dayDistribution">
        <td>{{ r.record }}</td>
        <td>{{ formatTime(r.eta * 60) }}</td>
        <td>{{ formatTime(r.real) }}</td>
        <td>{{ r.percentageEta }}</td>
        <td>{{ r.percentageReal }}</td>
      </tr>
    </table>

    <canvas
      *ngIf="viewData.dayDistributionChart.chartData[0].data.length > 0"
      id="dayDistributionChart"
      baseChart
      [datasets]="viewData.dayDistributionChart.chartData"
      [labels]="viewData.dayDistributionChart.chartLabels"
      [options]="viewData.dayDistributionChart.chartOptions"
      [legend]="viewData.dayDistributionChart.chartLegend"
      [type]="viewData.dayDistributionChart.chartType"
    >
    </canvas>
  </div>
</div>
<div *ngIf="options.optShowQualifiersTotals">
  <hr />
  <button
    class="button-link no-underline"
    (click)="toggleOption('optCollapseQualifiersTotals')"
  >
    <strong
      >{{ options.optCollapseQualifiersTotals ? '+' : '-' }} Qualifiers
      Totals</strong
    >
  </button>
  <div *ngIf="!options.optCollapseQualifiersTotals">
    <table>
      <tr>
        <td>Qualifier</td>
        <td>Task Count</td>
        <td>Total ETA</td>
      </tr>
      <tr *ngFor="let q of reports.qualifierTotals">
        <td>{{ q.qualifier }}</td>
        <td>{{ q.taskCount }}</td>
        <td>{{ formatTime(q.totalETA * 60) }}</td>
      </tr>
    </table>
  </div>
</div>

<div *ngIf="comparisonData">
  Client Task Count: {{ comparisonData.clientTaskCount }} <br />Server Task
  Count: {{ comparisonData.serverTaskCount }} <br />Comparison Task Count: {{
  comparisonData.results.length }}
  <table>
    <tr *ngFor="let c of comparisonData.results">
      <td *ngFor="let f of c">
        displayName: {{ f.displayName }} | name: {{ f.name }} | comparison: {{
        f.isEqual }} | data FE: {{ f.client }} | data BE: {{ f.server }}
        <button (click)="sendFEToBE(c)">Send FE data to BE</button>
      </td>
    </tr>
  </table>
</div>

<div
  class="task-item-toolbar"
  *ngIf="selectedTask"
  [ngClass]="{
  'mobile-only': !options.optShowTaskToolbar
}"
>
  <div>{{ selectedTask.tsk_name }}</div>
  <div class="task-item-toolbar-content">
    <span
      class="play-button clickable"
      *ngIf="selectedTask && selectedTask.tsk_ctg_in_process === 1"
      (click)="toggleTimeTracking(selectedTask, $event)"
      >&#9654;</span
    >
    <span
      class="stop-button clickable"
      *ngIf="selectedTask && selectedTask.tsk_ctg_in_process === 2"
      (click)="toggleTimeTracking(selectedTask, $event)"
      >&#9724;</span
    >
    <span
      class="adjust-timetracking-button clickable"
      (click)="adjustTimeTracking(selectedTask)"
      >&#8676;</span
    >
    <span
      class="set-selected-button clickable"
      (click)="setSelected(selectedTask)"
      >&#9998;</span
    >
    <span
      class="remove-qualifiers-button clickable"
      (click)="removeQualifiersFromTask(selectedTask)"
      >&#9746;</span
    >
    <span class="close-button clickable" (click)="selectedTask = null"
      >&times;</span
    >
  </div>
</div>

<task-toolbar
  [task]="selectedTask"
  [groupTasks]="selectedRecord"
  [handlers]="handlersForTaskToolbar"
  [options]="{
    optShowTaskToolbar: true
  }"
></task-toolbar>
